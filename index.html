<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>RasPiBrew by steve71</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">RasPiBrew</h1>
      <h2 class="project-tagline">Raspberry Pi Temperature Controller for homebrewing and sous vide cooking</h2>
      <a href="https://github.com/steve71/RasPiBrew" class="btn">View on GitHub</a>
      <a href="https://github.com/steve71/RasPiBrew/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/steve71/RasPiBrew/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="raspibrew-vessel-temperature-controller" class="anchor" href="#raspibrew-vessel-temperature-controller" aria-hidden="true"><span class="octicon octicon-link"></span></a>RasPiBrew Vessel Temperature Controller</h1>

<p><img src="https://github.com/steve71/RasPiBrew/raw/images/raspibrew_bootstrap.png" alt="RasPiBrew using Bootstrap"></p>

<p>This system is an inexpensive and flexible wireless web based controller for brewing, Sous Vide and similar applications.  With homebrewing it was originally targeted for electric brew in a bag (eBIAB), batch sparging in a cooler and extract methods but has recently been expanded on the desktop to multi-vessel and pump/stirrer control.  So, if you already have a propane system and looking to go electric or starting from scratch and looking for a way to control your setup this is an alternative. The most recent updates for this application are found on the RasPiBrew project page on Github.</p>

<p>Using the Android Smart Phone App or a Firefox web browser the temperature of a vessel can be controlled with a Raspberry Pi .  All status information including heat output percentage and current temperature are constantly sent back to the controller.  A very simple and inexpensive electronics hardware setup plus ease of use are the main goals of this project.  No custom made boards that are specific for this project are needed.  Also, using a web interface the level of customization is endless.</p>

<p>Download Software for Raspberry Pi Web Server.  Also, Control and Monitor your vessel temperature and heat output with an Android app.  Compatible with smartphones only.</p>

<p>New Version 1.1.1 of Android App:
<a href="https://play.google.com/store/apps/details?id=com.raspibrew">RasPiBrew Android</a> on Google Play</p>

<p><img src="https://github.com/steve71/RasPiBrew/raw/images/android/android_set.png" alt=""><img src="https://github.com/steve71/RasPiBrew/raw/images/android/android_chart.png" alt=""><img src="https://github.com/steve71/RasPiBrew/raw/images/android/android_temp_alert.png" alt=""></p>

<h1>
<a id="hardware-and-software-setup-instructions" class="anchor" href="#hardware-and-software-setup-instructions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hardware and Software Setup Instructions</h1>

<h2>
<a id="hardware" class="anchor" href="#hardware" aria-hidden="true"><span class="octicon octicon-link"></span></a>Hardware</h2>

<p>Parts List:</p>

<ul>
<li>$35 Raspberry Pi Model B</li>
<li>Adafruit Pi Plate or PiCrust breakout board</li>
<li>Jeelabs Thermo Plug circuit board without components (for 1wire and GPIO)</li>
<li>Jeelabs Thermo Plug components from Radio Shack: 4.7k resistor, 1k resistor, 1N4001 diode, 2N4401 transistor</li>
<li>headers and wire jumpers</li>
<li>1-wire DS18B20 digital thermometer</li>
<li>USB wifi adapter (Edimax EW-7811UN) and router</li>
<li>Optional:  20×4 LCD and LCD117 kit.  It is supported in the software</li>
<li>Optional: A Jeelabs Output Plug can also be used to drive more relays but requires software modification.</li>
</ul>

<p>The Jeelabs circuit board is connected to a temperature sensor and a solid state relay to control a heating element.   The setup is shown in the following schematic:</p>

<pre><code> ---------      ------- 
| 1-Wire  |    | Relay |
| Sensor  |    |       | 
| + - GND |    |  + -  |
 ---------      -------
  | |  |          | |           (Optional SSR Connections)
  ---------------------          -----------   ---------
 | Jeelabs Thermo Plug |        |  Relay 2 |  | Relay 3 | ...
 | PWR +3V GND AIO DIO |        |  +  -    |  |  +  -   |
  ---------------------          ----------    ---------     
    |   |   |   |   |             5V  |         5V  | 
  ------------------------            |             |
 | 5V  5V  GND  P4 P17    |     ---------------------------
 |                     5V |---| VCC   P0            P1 ... |
 |  Raspberry Pi/      GND|---| GND   Optional             |
 |  Adafruit Plate kit SDA|---| DIO   Jeelabs Output Plug  | 
 |                     SCL|---| AI0                        |
 |      5V GND TX         |    ----------------------------
  ------------------------
         |  |   |
      --------------   
     | 20x4 LCD and |
     | LCD117 kit   |
      --------------
</code></pre>

<p>Only the printed circuit board of the Jeelabs Thermo Plug is needed and solder:</p>

<ul>
<li>4.7k resistor</li>
<li>1k resistor</li>
<li>1N4001 Diode</li>
<li>2N4401 Transister</li>
</ul>

<p>Next, solder headers and connect everything together using wire jumpers according to the above schematic.</p>

<p>Note: The DS18B20 temp sensor can be connected to 3.3V or 5V on the Raspberry Pi. 
<a href="http://datasheets.maximintegrated.com/en/ds/DS18B20.pdf">DS18B20 DataSheet</a></p>

<h2>
<a id="software" class="anchor" href="#software" aria-hidden="true"><span class="octicon octicon-link"></span></a>Software</h2>

<p>Load Operating System onto SDCard</p>

<p>Download the raspberry pi operating system: <a href="http://www.raspberrypi.org/downloads">Raspberry Pi Downloads</a> Use <a href="http://www.softpedia.com/get/CD-DVD-Tools/Data-CD-DVD-Burning/Win32-Disk-Imager.shtml">Win32DiskImager</a> to install onto SDCARD. </p>

<p>In terminal type:
    'sudo apt-get update'<br>
    'sudo apt-get upgrade'</p>

<h3>
<a id="beginners-guide" class="anchor" href="#beginners-guide" aria-hidden="true"><span class="octicon octicon-link"></span></a>Beginner’s Guide</h3>

<p>Follow the <a href="http://elinux.org/RPi_Beginners">RasPi beginners guide</a> to get up and running:</p>

<p>Run <code>sudo setupcon</code> once manually after the keyboard is setup otherwise you may have long boot times.</p>

<h3>
<a id="wireless-setup" class="anchor" href="#wireless-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>Wireless Setup</h3>

<p>Lookup <a href="http://elinux.org/RPi_VerifiedPeripherals#USB_WiFi_Adapters">Compatible USB wifi devices</a> and install the drivers:</p>

<p>To set up a static ip address use the following in /etc/network/interfaces:</p>

<pre><code>auto lo

iface lo inet loopback
iface eth0 inet static

auto wlan0
iface wlan0 inet static
address 192.168.1.103
netmask 255.255.255.0
gateway 192.168.1.1
</code></pre>

<p>If no wireless password use:</p>

<pre><code>wireless-essid linksys
</code></pre>

<p>Otherwise use the following:</p>

<pre><code>wpa-ssid "ssid"
wpa-psk "wireless_key_passphrase" 
</code></pre>

<p>with the correct <code>ssid</code> (router name) and <code>wireless_key_passphrase</code>.</p>

<p><a href="http://www.penguintutor.com/blog/viewblog.php?blog=6306">Tutorial on setting up a static IP address</a>
<a href="https://help.ubuntu.com/community/WifiDocs/WiFiHowTo">Tutorial on setting up wifi device on linux</a></p>

<h3>
<a id="manual-installation" class="anchor" href="#manual-installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Manual Installation</h3>

<p>Python Modules:
Install pip (package installer):
     'sudo apt-get install python-setuptools'
     'sudo easy_install pip'</p>

<p>Install PySerial:
     sudo pip install pyserial
     <a href="http://pyserial.sourceforge.net/pyserial.html">PySerial Info</a></p>

<p>Install Python i2c and smbus:
     'sudo apt-get install python-smbus'
     <a href="http://www.acmesystems.it/i2c">smbus info</a></p>

<p>Install Flask:
     'sudo apt-get install python-dev'
     'sudo apt-get install libpcre3-dev'
     'sudo pip install Flask'
     <a href="http://flask.pocoo.org/">Flask Info</a></p>

<p>In Raspberry Pi terminal window:
    'sudo bash'
    'cd /var'
    'mkdir www'</p>

<p>Copy software to <code>/var/www</code> preserving the directory structure.</p>

<p>At the command prompt type:
'sudo nano /boot/config.txt'
At the bottom of the file add the line:
'dtoverlay=w1-gpio'
Save the file and then reboot.</p>

<p>Replace the temp sensor id in config.xml with the id of your DS18B20 temperature sensor found in the <code>/sys/bus/w1/devices/</code> directory on the Raspberry Pi.</p>

<p>Start Putty on Windows and type login name and password.
Program must be run as superuser: Type <code>sudo bash</code>
Start program by typing: <code>python raspibrew</code>
Next, start the web browser on a computer on your network. If ip address of the Raspberry Pi is <code>192.168.1.3</code> then point the browser to <code>http://192.168.1.3:5000</code> </p>

<h2>
<a id="how-to-start-raspibrew-on-boot-up" class="anchor" href="#how-to-start-raspibrew-on-boot-up" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to Start RasPiBrew on Boot up:</h2>

<p>Create a new file: <code>/etc/init.d/raspibrew</code> as superuser and insert the following script:</p>

<pre><code>#! /bin/sh
# /etc/init.d/raspibrew

### BEGIN INIT INFO
# Provides:          raspibrew
# Required-Start:    $remote_fs $syslog
# Required-Stop:     $remote_fs $syslog
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Simple script to start a program at boot
# Description:       A simple script from www.stuffaboutcode.com which will start / st$
### END INIT INFO

# If you want a command to always run, put it here

# Carry out specific functions when asked to by the system
case "$1" in
    start)
        echo "Starting RasPiBrew"
        # run application you want to start
        python /var/www/raspibrew.py
    ;;
    stop)
        echo "Stopping RasPiBrew"
        # kill application you want to stop
        killall python
        python /var/www/cleanupGPIO.py
    ;;
*)
    echo "Usage: /etc/init.d/raspibrew {start|stop}"
    exit 1
    ;;
esac

exit 0
</code></pre>

<p>Make script executable:
    <code>sudo chmod 755 /etc/init.d/raspibrew</code></p>

<p>Register script to be run at start-up:
    <code>sudo update-rc.d raspibrew defaults</code></p>

<p>To Remove script from start-up:
    <code>sudo update-rc.d -f raspibrew remove</code></p>

<p>To test starting the program:
    <code>sudo /etc/init.d/raspibrew start</code></p>

<p>To test stopping the program:
    <code>sudo /etc/init.d/raspibrew stop</code></p>

<p><a href="http://www.stuffaboutcode.com/2012/06/raspberry-pi-run-program-at-start-up.html">Run RasPi Program at Start Up Info</a></p>

<h3>
<a id="ide-for-development" class="anchor" href="#ide-for-development" aria-hidden="true"><span class="octicon octicon-link"></span></a>IDE for Development:</h3>

<p>Create root password on Raspberry Pi:
    <code>sudo passwd root</code>
Enter new UNIX password: <code>raspberry</code></p>

<p>Install <a href="http://www.aptana.com/products/studio3">Aptana Studio 3</a> for IDE on your computer:</p>

<p>This is used for programming in Python, Javascript, web page design and 1-click synchronization with Raspberry Pi</p>

<p>After creating a project and adding all source files, right click on project name.
Select <code>Publish</code> and then <code>Run Web Development Wizard...</code>
Select <code>FTP/SFTP/FTPS</code> and fill out the form as shown:
<img src="https://github.com/steve71/RasPiBrew/raw/images/aptana_sftp_connection-264x300.png" alt="">
Everytime files are saved on your computer they are automatically sent over to the Raspberry Pi.</p>

<h1>
<a id="technical-details" class="anchor" href="#technical-details" aria-hidden="true"><span class="octicon octicon-link"></span></a>Technical Details</h1>

<p>The language for the server side software is Python for rapid development. The web server/framework is web.py. Multiple processes connected with pipes to communicate between them are used. For instance, one process can only get the temperature while another turns a heating element on and off. A third parent temp control process can control the heating process with information from the temp process and relay the information back to the web server.</p>

<p>On the client side jQuery and various plugins can be used to display data such as line charts and gauges. Mouse overs on the temperature plot will show the time and temp for the individual points. It is currently working in a Firefox Browser.</p>

<p>jQuery and two jQuery plugins (jsGauge and Flot) are used in the client:
<a href="http://jquery.com">http://jquery.com</a>
<a href="http://code.google.com/p/jsgauge/">http://code.google.com/p/jsgauge/</a>
<a href="http://code.google.com/p/flot/">http://code.google.com/p/flot/</a></p>

<p>The PID algorithm was translated from C code to Python. The C code was from “PID Controller Calculus with full C source source code” by Emile van de Logt An explanation on how to tune it is from the following web site:
<a href="http://www.vandelogt.nl/htm/regelen_pid_uk.htm">http://www.vandelogt.nl/htm/regelen_pid_uk.htm</a></p>

<p>The PID can be tuned very simply via the Ziegler-Nichols open loop method. Just follow the directions in the controller interface screen, highlight the sloped line in the temperature plot and the parameters are automatically calculated. After tuning with the Ziegler-Nichols method the parameters still needed adjustment because there was an overshoot of about 2 degrees in my system. I did not want the temperature to go past the setpoint since it takes a long time to come back down. Therefore, the parameters were adjusted to eliminate the overshoot. For this particular system the Ti term was more than doubled and the Td parameter was set to about a quarter of the open loop calculated value. Also a simple moving average was used on the temperature data that was fed to the PID controller to help improve performance. Tuning the parameters via the Integral of Time weighted Absolute Error (ITAE-Load) would provide the best results as described on van de Logt’s website above.</p>

<h1>
<a id="brewing-equipment" class="anchor" href="#brewing-equipment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Brewing Equipment</h1>

<h2>
<a id="brewing-hardware-links" class="anchor" href="#brewing-hardware-links" aria-hidden="true"><span class="octicon octicon-link"></span></a>Brewing Hardware Links</h2>

<p>The electric brewery web site has great information on brewing hardware setup: <a href="http://www.theelectricbrewery.com/">http://www.theelectricbrewery.com/</a>
The following sites are good sources for parts: bargainfittings.com, brewhardware.com and brewershardware.com.</p>

<h2>
<a id="my-setup" class="anchor" href="#my-setup" aria-hidden="true"><span class="octicon octicon-link"></span></a>My Setup</h2>

<p>First, a GFCI protected outlet is needed as well as the correct wiring gauge for the amperage used. An electrician should inspect the wiring. The following schematic (from PJ on homebrewtalk.com) is what I followed for my system which uses a 15.5 gallon vessel. I replaced the Auberin PID with the RasPiBrew setup and the pump is not used. Instead, an ice cream maker motor attached to a stainless steel dry wall mixer is used to constantly stir the water or wort in the brew kettle. Otherwise, a temperature differential will occur above and below heating element. The pump or stirrer can be added to RasPibrew control with some software modifications and using the optional jeelabs output plug which can control up to 8 relays. Since I just turn it on and let it run, I didn’t think it was needed. I use both the Brew in a Bag (BIAB) and batch sparging in a cooler brewing methods.</p>

<p><img src="https://github.com/steve71/RasPiBrew/raw/images/equipment/Auberin-wiring1-a4-5500w-BIAB-30d6.jpg" alt="">
<img src="https://github.com/steve71/RasPiBrew/raw/images/equipment/toolbox_front-300x225.jpg" alt=""><img src="https://github.com/steve71/RasPiBrew/raw/images/equipment/toolbox_side.jpg" alt=""><img src="https://github.com/steve71/RasPiBrew/raw/images/equipment/toolbox_inside.jpg" alt="">
<img src="https://github.com/steve71/RasPiBrew/raw/images/equipment/brew_vessel.jpg" alt=""></p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/steve71/RasPiBrew">RasPiBrew</a> is maintained by <a href="https://github.com/steve71">steve71</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
